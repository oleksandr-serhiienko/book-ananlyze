<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Sentence Processor</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Book Sentence Processor</h1>
            <p>Process and translate book sentences using AI</p>
        </header>

        <main>
            <!-- Processing Mode Selection -->
            <section class="mode-selector">
                <div class="tabs">
                    <button id="sentenceTab" class="tab-button active">Sentence Processing</button>
                    <button id="sentenceBatchTab" class="tab-button">Sentence Batch</button>
                    <button id="wordTab" class="tab-button">Word Processing</button>
                    <button id="wordBatchTab" class="tab-button">Word Batch</button>
                    <button id="epubTab" class="tab-button">EPUB Processor</button>
                </div>
            </section>

            <section class="controls">
                <div class="input-group" id="textFileGroup">
                    <label for="textFile">Text File Path:</label>
                    <div class="file-input-group">
                        <input type="text" id="textFile" placeholder="Enter path to text file">
                        <input type="file" id="textFileInput" accept=".txt,.text" style="display: none;">
                        <button type="button" id="browseTextBtn" class="btn-browse">Browse...</button>
                    </div>
                </div>
                
                <!-- Sentence Processing Mode Info -->
                <div class="input-group" id="sentenceModeInfo">
                    <label>Processing Mode:</label>
                    <span style="color: #2d3748; font-weight: 500;">Sentence-by-Sentence Translation</span>
                    <p style="color: #4a5568; font-size: 0.9em; margin: 5px 0 0 0;">5 sentences processed in parallel for maximum speed</p>
                </div>


                <!-- Word Processing Mode Info -->
                <div class="input-group" id="wordModeInfo" style="display: none;">
                    <label>Processing Mode:</label>
                    <span style="color: #2d3748; font-weight: 500;">Word Extraction & Translation</span>
                    <p style="color: #4a5568; font-size: 0.9em; margin: 5px 0 0 0;">Extract unique words, check database, and translate new words concurrently</p>
                </div>

                <!-- Word Batch Mode Info -->
                <div class="input-group" id="wordBatchModeInfo" style="display: none;">
                    <label>Processing Mode:</label>
                    <span style="color: #2d3748; font-weight: 500;">Word Batch JSONL Generation</span>
                    <p style="color: #4a5568; font-size: 0.9em; margin: 5px 0 0 0;">Extract unique words, check database, and generate JSONL for missing words only</p>
                </div>

                <!-- EPUB Processing Mode Info -->
                <div class="input-group" id="epubModeInfo" style="display: none;">
                    <label>Processing Mode:</label>
                    <span style="color: #2d3748; font-weight: 500;">EPUB to Text Converter</span>
                    <p style="color: #4a5568; font-size: 0.9em; margin: 5px 0 0 0;">Convert EPUB books to plain text files (.txt)</p>
                </div>

                <!-- Database Configuration for Word Processing -->
                <div class="input-group" id="databaseConfigGroup" style="display: none;">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">Database Configuration</h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                        <div>
                            <label for="databasePath">Database Path:</label>
                            <div class="file-input-group">
                                <input type="text" id="databasePath" value="MudadibFullGemini.db" placeholder="Enter database file path">
                                <input type="file" id="databaseFileInput" accept=".db,.sqlite,.sqlite3" style="display: none;">
                                <button type="button" id="browseDatabaseBtn" class="btn-browse">Browse...</button>
                            </div>
                            <p style="color: #4a5568; font-size: 0.85em; margin: 5px 0 0 0;">Database to check for existing words before processing (supports .db, .sqlite, .sqlite3 files)</p>
                            
                            <!-- Quick Database Options -->
                            <div style="margin-top: 10px;">
                                <label style="font-size: 0.9em; color: #4a5568;">Quick Select:</label>
                                <div style="display: flex; gap: 10px; margin-top: 5px; flex-wrap: wrap;">
                                    <button type="button" class="db-quick-btn" data-db="MudadibFullGemini.db">üóÉÔ∏è Default DB</button>
                                    <button type="button" class="db-quick-btn" data-db="">üö´ No Database</button>
                                    <button type="button" class="db-quick-btn" data-db="words.db">üìö words.db</button>
                                    <button type="button" class="db-quick-btn" data-db="translations.db">üåê translations.db</button>
                                    <button type="button" class="db-quick-btn" data-db="backup.db">üíæ backup.db</button>
                                </div>
                                <p style="color: #718096; font-size: 0.8em; margin: 8px 0 0 0; font-style: italic;">üí° Tip: "No Database" will process all words without checking existing entries</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EPUB File Configuration -->
                <div class="input-group" id="epubConfigGroup" style="display: none;">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">EPUB File Configuration</h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                        <div>
                            <label for="epubFile">EPUB File Path:</label>
                            <div class="file-input-group">
                                <input type="text" id="epubFile" placeholder="Enter path to EPUB file" style="width: 100%;">
                                <input type="file" id="epubFileInput" accept=".epub" style="display: none;">
                                <button type="button" id="browseEpubBtn" class="btn-browse">Browse...</button>
                            </div>
                            <p style="color: #4a5568; font-size: 0.85em; margin: 5px 0 0 0;">Select an EPUB file to extract text from (.epub files)</p>
                        </div>
                    </div>
                </div>
                
                <!-- Shared AI Configuration -->
                <div class="input-group" id="aiConfigGroup">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">AI Model Configuration</h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label for="projectId">Project ID:</label>
                                <input type="text" id="projectId" value="188935312243">
                            </div>
                            <div>
                                <label for="location">Location:</label>
                                <input type="text" id="location" value="europe-southwest1">
                            </div>
                        </div>
                        <div>
                            <label for="modelEndpoint">Model Endpoint:</label>
                            <input type="text" id="modelEndpoint" value="projects/188935312243/locations/europe-southwest1/endpoints/3012068123827240960" style="width: 100%; font-size: 0.85em;">
                        </div>
                    </div>
                </div>

                <!-- Rollback Models Configuration -->
                <div class="input-group" id="rollbackModelsGroup">
                    <div class="rollback-models-section">
                        <!-- Toggle Button -->
                        <button type="button" class="rollback-toggle-btn" onclick="toggleRollbackModels()">
                            <span class="toggle-icon">‚ñ∂</span>
                            <span class="toggle-text">Rollback Models (Optional)</span>
                        </button>
                        
                        <!-- Collapsible Rollback Models Section -->
                        <div id="rollbackModelsContainer" class="rollback-container" style="display: none;">
                            <div class="rollback-info">
                                <p>Configure up to 3 fallback models that will be used if the primary model fails after 5 attempts.</p>
                            </div>
                            
                            <div class="rollback-models-list">
                                <div class="rollback-model-item">
                                    <label for="rollbackModel1">Rollback Model 1:</label>
                                    <input type="text" id="rollbackModel1" name="rollbackModel1" placeholder="e.g., gemini-1.5-flash">
                                    <button type="button" class="remove-model-btn" onclick="clearRollbackModel(1)">√ó</button>
                                </div>
                                
                                <div class="rollback-model-item">
                                    <label for="rollbackModel2">Rollback Model 2:</label>
                                    <input type="text" id="rollbackModel2" name="rollbackModel2" placeholder="e.g., gemini-1.0-pro">
                                    <button type="button" class="remove-model-btn" onclick="clearRollbackModel(2)">√ó</button>
                                </div>
                                
                                <div class="rollback-model-item">
                                    <label for="rollbackModel3">Rollback Model 3:</label>
                                    <input type="text" id="rollbackModel3" name="rollbackModel3" placeholder="e.g., text-bison">
                                    <button type="button" class="remove-model-btn" onclick="clearRollbackModel(3)">√ó</button>
                                </div>
                            </div>
                            
                            <div class="rollback-actions">
                                <button type="button" class="clear-all-btn" onclick="clearAllRollbackModels()">Clear All</button>
                                <button type="button" class="load-saved-btn" onclick="loadSavedRollbackModels()">Load Saved</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Translation Configuration -->
                <div class="input-group" id="translationConfigGroup">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">Translation Configuration</h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label for="sourceLanguage">Source Language:</label>
                                <select id="sourceLanguage">
                                    <option value="German">German</option>
                                </select>
                            </div>
                            <div>
                                <label for="targetLanguage">Target Language:</label>
                                <select id="targetLanguage">
                                    <option value="English">English</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Batch Language Configuration -->
                <div class="input-group" id="batchLanguageConfigGroup" style="display: none;">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">Language Configuration</h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label for="batchSourceLanguage">Source Language:</label>
                                <select id="batchSourceLanguage">
                                    <option value="German">German</option>
                                </select>
                            </div>
                            <div>
                                <label for="batchTargetLanguage">Target Language:</label>
                                <select id="batchTargetLanguage">
                                    <option value="English">English</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Word Batch Configuration -->
                <div class="input-group" id="wordBatchConfigGroup" style="display: none;">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">Word Batch Configuration</h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label for="wordBatchSourceLanguage">Source Language:</label>
                                <select id="wordBatchSourceLanguage">
                                    <option value="German">German</option>
                                </select>
                            </div>
                            <div>
                                <label for="wordBatchTargetLanguage">Target Language:</label>
                                <select id="wordBatchTargetLanguage">
                                    <option value="English">English</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="wordBatchDatabasePath">Database Path (optional):</label>
                            <div class="file-input-group">
                                <input type="text" id="wordBatchDatabasePath" placeholder="Leave empty to process all words">
                                <input type="file" id="wordBatchDatabaseInput" accept=".db,.sqlite,.sqlite3" style="display: none;">
                                <button type="button" id="browseWordBatchDatabaseBtn" class="btn-browse">Browse...</button>
                            </div>
                        </div>
                        
                        <!-- Response Processing Section -->
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                            <h4 style="color: #4a5568; margin-bottom: 10px;">Response Processing</h4>
                            <p style="color: #718096; font-size: 0.85em; margin-bottom: 10px;">Process Vertex AI response file (.jsonl) to generate SQL inserts</p>
                            <div>
                                <label for="responseFilePath">Response File (.jsonl):</label>
                                <div class="file-input-group">
                                    <input type="text" id="responseFilePath" placeholder="Select Vertex AI response file (.jsonl)">
                                    <input type="file" id="responseFileInput" accept=".jsonl,.json" style="display: none;">
                                    <button type="button" id="browseResponseBtn" class="btn-browse">Browse...</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                

                <div class="button-group">
                    <button id="startProcessing" class="btn-primary">Start Processing</button>
                    <button id="stopProcessing" class="btn-secondary" disabled>Stop Processing</button>
                    <button id="processResponse" class="btn-primary" style="display: none;">Process Response File</button>
                    <button id="downloadSQL" class="btn-success" disabled>Download Results</button>
                </div>
            </section>

            <section class="status">
                <div class="status-item">
                    <span class="label">Status:</span>
                    <span id="processingStatus" class="value">Ready</span>
                </div>
                <div class="status-item">
                    <span class="label">Progress:</span>
                    <span id="processingProgress" class="value">0/0</span>
                </div>
                <div class="status-item">
                    <span class="label">Success Rate:</span>
                    <span id="successRate" class="value">0%</span>
                </div>
            </section>

            <section class="progress-section">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </section>

            <section class="logs">
                <h2>Processing Logs</h2>
                <div class="log-container">
                    <div id="logOutput" class="log-output"></div>
                </div>
                <button id="clearLogs" class="btn-secondary">Clear Logs</button>
            </section>

            <section class="results">
                <h2 id="resultsTitle">Results Summary</h2>
                
                <!-- Sentence Processing Results -->
                <div class="results-grid" id="sentenceResults">
                    <div class="result-card">
                        <h3>Total Lines</h3>
                        <span id="totalLines" class="result-number">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Successful</h3>
                        <span id="successfulLines" class="result-number success">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Failed</h3>
                        <span id="failedLines" class="result-number error">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Processing Time</h3>
                        <span id="processingTime" class="result-number">0s</span>
                    </div>
                </div>

                <!-- Sentence Batch Processing Results -->
                <div class="results-grid" id="sentenceBatchResults" style="display: none;">
                    <div class="result-card">
                        <h3>Total Lines</h3>
                        <span id="batchTotalLines" class="result-number">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Processed</h3>
                        <span id="batchProcessedLines" class="result-number">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Successful</h3>
                        <span id="batchSuccessfulLines" class="result-number success">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Failed</h3>
                        <span id="batchFailedLines" class="result-number error">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Processing Time</h3>
                        <span id="batchProcessingTime" class="result-number">0s</span>
                    </div>
                </div>

                <!-- Word Processing Results -->
                <div class="results-grid" id="wordResults" style="display: none;">
                    <div class="result-card">
                        <h3>Total Words</h3>
                        <span id="totalWords" class="result-number">0</span>
                    </div>
                    <div class="result-card">
                        <h3>New Words</h3>
                        <span id="newWords" class="result-number">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Successful</h3>
                        <span id="successfulWords" class="result-number success">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Failed</h3>
                        <span id="failedWords" class="result-number error">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Processing Time</h3>
                        <span id="wordProcessingTime" class="result-number">0s</span>
                    </div>
                </div>

                <!-- Word Batch Processing Results -->
                <div class="results-grid" id="wordBatchResults" style="display: none;">
                    <div class="result-card">
                        <h3>Total Words</h3>
                        <span id="wordBatchTotalWords" class="result-number">0</span>
                    </div>
                    <div class="result-card">
                        <h3>New Words</h3>
                        <span id="wordBatchNewWords" class="result-number">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Processed</h3>
                        <span id="wordBatchProcessedWords" class="result-number success">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Skipped (in DB)</h3>
                        <span id="wordBatchSkippedWords" class="result-number">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Processing Time</h3>
                        <span id="wordBatchProcessingTime" class="result-number">0s</span>
                    </div>
                </div>

                <!-- EPUB Processing Results -->
                <div class="results-grid" id="epubResults" style="display: none;">
                    <div class="result-card">
                        <h3>Chapters Extracted</h3>
                        <span id="chapterCount" class="result-number">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Text Length</h3>
                        <span id="textLength" class="result-number">0</span>
                    </div>
                    <div class="result-card">
                        <h3>Status</h3>
                        <span id="epubStatus" class="result-number">Ready</span>
                    </div>
                    <div class="result-card">
                        <h3>File Size</h3>
                        <span id="epubFileSize" class="result-number">-</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="app.js"></script>
</body>
</html>